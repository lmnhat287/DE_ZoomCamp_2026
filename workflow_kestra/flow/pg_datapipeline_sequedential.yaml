id: 06_backfill_2021_sequential
namespace: zoom_camp

tasks:
  # KHỐI 1: CHẠY GREEN TAXI TRƯỚC (Dung lượng nhẹ)
  - id: green_taxi_group
    type: io.kestra.plugin.core.flow.ForEach
    values: ["01", "02", "03", "04", "05", "06", "07"]
    tasks:
      - id: ingest_green
        type: io.kestra.plugin.core.flow.Subflow
        flowId: 04_postgres_taxi
        namespace: zoom_camp
        inputs:
          taxi: green
          year: "2021"
          month: "{{ taskrun.value }}"
        wait: true # Đợi xong tháng này mới sang tháng sau

  # KHỐI 2: CHẠY YELLOW TAXI SAU (Dung lượng nặng)
  - id: yellow_taxi_group
    type: io.kestra.plugin.core.flow.ForEach
    values: ["01", "02", "03", "04", "05", "06", "07"]
    tasks:
      - id: ingest_yellow
        type: io.kestra.plugin.core.flow.Subflow
        flowId: 04_postgres_taxi
        namespace: zoom_camp
        inputs:
          taxi: yellow
          year: "2021"
          month: "{{ taskrun.value }}"
        wait: true # Quan trọng: Giúp Postgres không bị quá tải